<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div>
      <h1 >Runeterra's greatest Caf√©</h1>
      <h2>Hello Voidborn</h2>
      <h3 id="userGreeting">Please choose drinks to have</h3>
    </div>
    <div id="listAreaReg" display="inline">
      <em>From earth we propose these drinks:</em><br />
    </div>
    <br />
    <div id="listAreaSpecial">
      <em
        >You can also find drinks from your planet that you can enjoy on
        earth:<br
      /></em>
    </div>
    <br />
    <div id="cart">
      <p>total:</p>
      <span id="total">0</span>
    </div>
    <button id="confirmCart">confirm cart and checkout</button>

    <script>
      async function getDrinkLists(id, userName) {
        document.getElementById(
          "userGreeting"
        ).innerHTML += `<p id="name">name:${userName} id:${id}</p>`;

        try {
          const data = await fetch("/drinks");
          const drinkList = await data.json();
          const listAreaReg = document.getElementById("listAreaReg");
          const listAreaSpecial = document.getElementById("listAreaSpecial");
          const regular = drinkList.normal;
          const special = drinkList.voidborn;

          regular.forEach((element) => {
            listAreaReg.innerHTML += ` <div class="product">
    <h2>${element.drinkName}</h2>   <p>price:${element.price} BE</p><p class="id" >id: ${element.id}</p><br>
    <input type="number" class="quantity" value="1" min="1">
    <button class="addToCart">Add to Cart</button>
   </div>`;
          });
          special.forEach((element) => {
            listAreaSpecial.innerHTML += ` <div class="product">
    <h2>${element.drinkName}</h2>   <p>price:${element.price} BE</p><p class="id">id: ${element.id}</p><br>
    <input type="number" class="quantity" value="1" min="1">
    <button class="addToCart">Add to Cart</button>
   </div>`;
          });

          //the function that creates the product place in the cart and accumulate the total 

          const addToCartButtons = document.querySelectorAll(".addToCart");
          addToCartButtons.forEach((button) => {
            button.addEventListener("click", async (event) => {
              const product = event.currentTarget.parentNode;
              const productId = product
                .querySelector(".id")
                .textContent.split(" ")[1];
              const quantity = product.querySelector(".quantity").value;

              // Fetch the product details 
              try {
                const drinkToAdd = await getProductById(productId);

                const drinkTotal = drinkToAdd.price * quantity;

                // Update the cart total
                const cart = document.getElementById("cart");
                const cartTotal = document.getElementById("total");
                let total = parseInt(cartTotal.innerText) || 0; 
                total += drinkTotal;
                cartTotal.innerText = total;
                try {
                  const data = fetch(
                    `/drinks/cart?id=${id}&user=${userName}&name=${drinkToAdd.drinkName}&qty=${quantity}&price=${drinkToAdd.price}&drinkId=${drinkToAdd.id}`,
                    { method: "POST" }
                  );
                } catch {
                  console.log(error);
                }

                // Add the item to the cart
                cart.innerHTML += `<p>${drinkToAdd.drinkName}   QTY:${quantity}   ${drinkTotal}BE</p>`;
              } catch (error) {
                console.error(error);
              }
            });
          });
        } catch (error) {
          console.log(error);
        }
      }
      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userName = urlParams.get("name");
        const id = urlParams.get("id");
        getDrinkLists(id, userName);
        document.getElementById('confirmCart').addEventListener('click' ,(evnet) => {
        window.location.href = `/cart.html?id=${id}&name=${userName }`
      })
      };

      // get product that matches the id
      async function getProductById(id) {
        try {
          const data = await fetch(`/drinks/${id}`);
          const product = await data.json();
          return product;
        } catch (err) {
          console.log(err);
        }
      }
      //confirm the cart and pass to che koutn 
      
    </script>
  </body>
</html>


<!-- salam -->
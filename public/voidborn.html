<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <div class="container">
    <div class="headers">
      <h1 class="title header">Doran's afterhour Caf√©</h1>
      <h3 id="test" class="title third">  </h3>
      <h4 class="title fourth">Please choose drinks to have</h4>
    </div>
    <div class="onPageItems">
      <div id="listAreaReg" display="inline" class="listAreaReg">
        <em class="Idrink">From Ionia we propose these drinks:</em><br />
      </div>
      <br />
      <div id="listAreaSpecial" class="listAreaSpecial">
        <em class="vbdrink">
          You can also find drinks from your realm that you can enjoy on Ionia:<br/></em>
      </div>
      <br />
      <div id="cart" class="cartVB">
        <p>total:</p>
        <span id="total">0</span>
      </div>
      <button id="confirmCart">confirm cart and checkout</button>
      </div>
     </div>










    <script>
      async function getDrinkLists(id, userName) {
        document.getElementById(
          "test"
        ).innerHTML += `<h3 id="name"> You are ${userName} and your number of reservation is ${id}</h3>`;

        try {
          const data = await fetch("/drinks");
          const drinkList = await data.json();
          const listAreaReg = document.getElementById("listAreaReg");
          const listAreaSpecial = document.getElementById("listAreaSpecial");
          const regular = drinkList.normal;
          const special = drinkList.voidborn;

          regular.forEach((element) => {
            listAreaReg.innerHTML += ` <div class="product">
    <h2>${element.drinkName}</h2>   <p>price:${element.price} BE</p><p class="id" >id: ${element.id}</p><br>
    <input type="number" class="quantity" value="1" min="1">
    <button class="addToCart">Add to Cart</button>
   </div>`;
          });
          special.forEach((element) => {
            listAreaSpecial.innerHTML += ` <div class="product">
    <h2>${element.drinkName}</h2>   <p>price:${element.price} BE</p><p class="id">id: ${element.id}</p><br>
    <input type="number" class="quantity" value="1" min="1">
    <button class="addToCart">Add to Cart</button>
   </div>`;
          });

          const addToCartButtons = document.querySelectorAll(".addToCart");
          addToCartButtons.forEach((button) => {
            button.addEventListener("click", async (event) => {
              const product = event.currentTarget.parentNode;
              const productId = product
                .querySelector(".id")
                .textContent.split(" ")[1];
              const quantity = product.querySelector(".quantity").value;

              // Fetch the product details asynchronously
              try {
                const drinkToAdd = await getProductById(productId);

                // Calculate the total price for the current item
                const drinkTotal = drinkToAdd.price * quantity;

                // Update the cart total
                const cart = document.getElementById("cart");
                const cartTotal = document.getElementById("total");
                let total = parseInt(cartTotal.innerText) || 0; // Set default to 0
                total += drinkTotal;
                cartTotal.innerText = total;
                try {
                  const data = fetch(
                    `/drinks/cart?id=${id}&user=${userName}&name=${drinkToAdd.drinkName}&qty=${quantity}&price=${drinkToAdd.price}`,
                    { method: "POST" }
                  );
                } catch {
                  console.log(error);
                }

                // Add the item to the cart
                cart.innerHTML += `<p>${drinkToAdd.drinkName}   QTY:${quantity}   ${drinkTotal}BE</p>`;
              } catch (error) {
                console.error(error);
              }
            });
          });
        } catch (error) {
          console.log(error);
        }
      }
      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userName = urlParams.get("name");
        const id = urlParams.get("id");
        getDrinkLists(id, userName);
        document.getElementById('confirmCart').addEventListener('click' ,(evnet) => {
        window.location.href = `/cart.html?id=${id}&name=${userName }`
      })
      };

      // get product that matches the id
      async function getProductById(id) {
        try {
          const data = await fetch(`/drinks/${id}`);
          const product = await data.json();
          return product;
        } catch (err) {
          console.log(err);
        }
      }
      //confirm the cart and pass to che koutn 
      
    </script>
  </body>
</html>
